package rules

import com.sbnz.crcalculator.facts.Monster;
import com.sbnz.crcalculator.facts.ChallengeRating;
import com.sbnz.crcalculator.facts.AttackType;

rule "Determine challenge rating" salience -1
	    when
	        $m: Monster() @Watch(actions)
	        finalChallengeRating($cr;)
	    then
	    	System.out.println("Challenge rating calculated to " + $cr.getValue());
	        modify ($m) { setChallengeRating($cr) };
end

query finalChallengeRating(ChallengeRating $cr)
	$m: Monster()
	offensiveChallengeRating($off;)
	defensiveChallengeRating($def;)
	getChallengeRating($cr, ($off.getOrdinal() + $def.getOrdinal())/2, $m.getChallengeRating();)
end

query getChallengeRating(ChallengeRating $cr, Integer expectedOrdinal, ChallengeRating currentChallengeRating)
	$cr := ChallengeRating(ordinal == expectedOrdinal, this != currentChallengeRating)
end

query maxDamageAction(Action $action)
	Monster($actions: actions)
	$action := Action($avg: averageDamage) from $actions
	not Action(averageDamage > $avg) from $actions
end

query highestAttackBonus(Action action, Integer $attackBonus)
	Attack($attackBonus := attackBonus, type == AttackType.ATTACK_ROLL) from action.getAttacks()
	not (Attack(attackBonus > $attackBonus, type == AttackType.ATTACK_ROLL) from action.getAttacks())
end

query baseOffensiveChallengeRating(ChallengeRating $cr, Action $action)
	maxDamageAction($action;)
	$cr := ChallengeRating(minDamage <= $action.getAverageDamage(), maxDamage >= $action.getAverageDamage())
end

query adjustedForAttackRoll(ChallengeRating $cr)
	baseOffensiveChallengeRating($base, $action;)
	highestAttackBonus($action, $attackBonus;)
	getChallengeRating($cr, $base.getOrdinal() + ($attackBonus - $base.getAttackBonus())/2, null;)
end

query offensiveChallengeRating(ChallengeRating $cr)
	$cr := ChallengeRating(ordinal == 100) or //TODO: Implement adjustedForSaveDc($cr;)
	adjustedForAttackRoll($cr;)
end

query defensiveChallengeRating(ChallengeRating $cr)
	$m: Monster($hp: averageHitPoints) and
	ChallengeRating(minHitPoints <= $hp, maxHitPoints >= $hp, $ac: armorClass, $o: ordinal) and
	getChallengeRating($cr, $o + ($m.getArmorClass() - $ac)/2, null;)
end